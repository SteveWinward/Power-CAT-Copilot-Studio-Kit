(()=>{var e={d:(t,o)=>{for(var i in o)e.o(o,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:o[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{"use strict";e.r(t),e.d(t,{TestRunExecutorService:()=>d});const o={STATE_KEY:"agent_auth_state",POSSIBLE_CHARS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",STATE_LENGTH:32,CODE_VERIFIER_LENGTH:64,AUTH_WINDOW_WIDTH:600,AUTH_WINDOW_HEIGHT:600,POLL_INTERVAL:100,AUTH_TIMEOUT:3e5,WIDTH:600,HEIGHT:600},i={PROGRESS:{id:"TESTRUN_ACTION_NOTIFICATION",message:"Test Run execution is in progress.",type:"INFO"},WARNING:{id:"TESTRUN_WARNING_NOTIFICATION",type:"WARNING"},ERROR:{id:"TESTRUN_ONSAVE_NOTIFICATION",type:"ERROR"}},r=7e3,n=200;var a=function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function a(e){try{s(i.next(e))}catch(e){n(e)}}function c(e){try{s(i.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}s((i=i.apply(e,t||[])).next())}))};class c{constructor(e,t,o,i){this.clientId=e,this.tenantId=t,this.scopes=[o],this.clientUrl=i}generateRandomString(e){return Array.from(crypto.getRandomValues(new Uint8Array(e))).map((e=>o.POSSIBLE_CHARS[e%o.POSSIBLE_CHARS.length])).join("")}generateCodeChallenge(e){return a(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),o=yield window.crypto.subtle.digest("SHA-256",t);return btoa(String.fromCharCode(...new Uint8Array(o))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}))}validateAuthResponse(e,t){return a(this,void 0,void 0,(function*(){const i=sessionStorage.getItem(o.STATE_KEY);if(!i)throw new Error("No stored state found");const{state:r}=JSON.parse(i);if(!e||!t)throw new Error("Authorization code or state missing from response");if(t!==r)throw new Error("State mismatch - possible CSRF attack");return e}))}getAuthorizationCode(){return a(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{const i=this.generateRandomString(o.STATE_LENGTH),r=this.generateRandomString(o.CODE_VERIFIER_LENGTH);sessionStorage.setItem(o.STATE_KEY,JSON.stringify({state:i,codeVerifier:r,timestamp:Date.now()})),this.generateCodeChallenge(r).then((r=>{const n=new URLSearchParams({client_id:this.clientId,response_type:"code",redirect_uri:this.clientUrl,scope:this.scopes.join(" "),state:i,code_challenge:r,code_challenge_method:"S256",prompt:"login",response_mode:"fragment"}),a=`https://login.microsoftonline.com/${this.tenantId}/oauth2/v2.0/authorize?${n.toString()}`,{WIDTH:c,HEIGHT:s}=o,d=window.screen.width/2-c/2,u=window.screen.height/2-s/2,l=window.open(a,"Login",`width=${c},height=${s},left=${d},top=${u},menubar=no,toolbar=no,location=no,status=no`);if(!l)return void t(new Error("Popup window was blocked. Please allow popups for this site."));let h;const f=()=>{clearInterval(h),l.closed||l.close()};h=window.setInterval((()=>{try{if(l.closed)return f(),void e({authCode:null,codeVerifier:null});if(l.location.href.includes("#")){f();const t=new URLSearchParams(l.location.hash.substring(1)),i=t.get("code"),r=t.get("state");i&&r?this.validateAuthResponse(i,r).then((t=>{if(t){const i=sessionStorage.getItem(o.STATE_KEY),{codeVerifier:r}=i?JSON.parse(i):{codeVerifier:null};e({authCode:t,codeVerifier:r})}else e({authCode:null,codeVerifier:null})})):e({authCode:null,codeVerifier:null})}}catch(e){e instanceof Error&&e.message.includes("cross-origin")||(f(),t(new Error(`Error polling auth window: ${e}`)))}}),o.POLL_INTERVAL),setTimeout((()=>{f(),e({authCode:null,codeVerifier:null})}),o.AUTH_TIMEOUT)}))}catch(e){t(e)}}))}))}}var s=function(e,t,o,i){return new(o||(o=Promise))((function(r,n){function a(e){try{s(i.next(e))}catch(e){n(e)}}function c(e){try{s(i.throw(e))}catch(e){n(e)}}function s(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(a,c)}s((i=i.apply(e,t||[])).next())}))};class d{constructor(e,t,o,i,r){this.formContext=r,this.authService=new c(e,t,o,i)}waitForRecordId(){return s(this,arguments,void 0,(function*(e=r,t=n){let o=this.formContext.data.entity.getId(),i=0;const a=e/t;for(;!o&&i<a;)yield new Promise((e=>setTimeout(e,t))),o=this.formContext.data.entity.getId(),i++;return o?o.replace(/[{},]/g,""):null}))}removeNotification(e){setTimeout((()=>{this.formContext.ui.clearFormNotification(e)}),12e3)}invokeDataverseAction(e,t,o,r){return s(this,void 0,void 0,(function*(){try{const n=this.formContext.getAttribute("cat_copilottestsetid").getValue()[0].id.replace(/[{},]/g,""),a={entityType:this.formContext.data.entity.getEntityName(),id:yield this.waitForRecordId()},c={entity:a,AuthCode:t,CodeVerifier:o,CopilotConfigurationId:e,CopilotTestRunId:a.id,CopilotTestSetId:n,getMetadata:()=>({boundParameter:"entity",parameterTypes:{entity:{typeName:"mscrm.cat_copilottestrun",structuralProperty:5},AuthCode:{typeName:"Edm.String",structuralProperty:1},CodeVerifier:{typeName:"Edm.String",structuralProperty:1},CopilotConfigurationId:{typeName:"Edm.String",structuralProperty:1},CopilotTestRunId:{typeName:"Edm.String",structuralProperty:1},CopilotTestSetId:{typeName:"Edm.String",structuralProperty:1}},operationType:0,operationName:"cat_RunCopilotTests"})};if(!(yield Xrm.WebApi.online.execute(c)).ok)throw new Error("Failed to execute the action.");{const{PROGRESS:e,WARNING:t}=i;this.formContext.ui.setFormNotification(e.message,e.type,e.id),this.removeNotification(e.id),r&&(this.formContext.ui.setFormNotification(r,t.type,t.id),this.removeNotification(t.id))}}catch(e){throw new Error(`Failed to execute the action. Error Message: ${e instanceof Error?e.message:"Unknown error"}`)}}))}static onSave(e){return s(this,void 0,void 0,(function*(){if(!e)return;const t=e.getFormContext();if(1===t.ui.getFormType())try{const e=Xrm.Utility.getGlobalContext().getClientUrl(),o=t.getAttribute("cat_copilotconfigurationid").getValue()[0].id.replace(/[{},]/g,""),i=yield Xrm.WebApi.retrieveRecord("cat_copilotconfiguration",o,"?$select=cat_clientid,cat_tenantid,cat_userauthenticationcode,cat_scope"),r=new d(i.cat_clientid,i.cat_tenantid,i.cat_scope,e,t);let n={authCode:null,codeVerifier:null},a="";if(2===i.cat_userauthenticationcode){if(n=yield r.authService.getAuthorizationCode(),!n.authCode||!n.codeVerifier)throw new Error("Failed to obtain authorization code or code verifier");a="This agent configuration is configured with end-user authentication, which relies on Entra ID tokens with a limited lifetime. Consider splitting your test set if it takes longer than an hour to complete."}yield r.invokeDataverseAction(o,n.authCode,n.codeVerifier,a)}catch(e){const{ERROR:o}=i;t.ui.setFormNotification(`An error occurred while running the test. ${e instanceof Error?e.message:"Unknown error"}`,o.type,o.id),d.prototype.removeNotification(o.id)}}))}}window.onSave=d.onSave})();var o=cat="undefined"==typeof cat?{}:cat;for(var i in t)o[i]=t[i];t.__esModule&&Object.defineProperty(o,"__esModule",{value:!0})})();